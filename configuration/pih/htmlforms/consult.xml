<!--
  ~ The contents of this file are subject to the OpenMRS Public License
  ~ Version 1.0 (the "License"); you may not use this file except in
  ~ compliance with the License. You may obtain a copy of the License at
  ~ http//license.openmrs.org
  ~
  ~ Software distributed under the License is distributed on an "AS IS"
  ~ basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing rights and limitations
  ~ under the License.
  ~
  ~ Copyright (C) OpenMRS, LLC.  All Rights Reserved.
  -->



<htmlform formName="Consult"
          formUuid="b5a50e02-bc3b-4bc9-8d6f-a4decad17a97"
          formEncounterType="aa61d509-6e76-4036-a65d-7813c0c3b752"
          formVersion="1.0">

    <style type="text/css">

        #who-when-where {
            margin-bottom: 6px;
            border-bottom: 1px solid #ccc;
        }

        #who-when-where p {
            display: inline-block;
            padding-right: 20px;
        }

        #where > input[type=text] {
            display: inline-block;
        }

        .field-error {
            color: #ffc0b5;
            font-size: 1.1em;
            display: block;
        }

        .legalValue {
            background-color: white !important;
        }

        .two-columns {
            display: table;
            height: 100%;
            width: 100%;
        }

        .two-columns > div {
            display: table-cell;
            width: 50%;
        }

        .three-columns {
            column-count: 3;
            -webkit-column-count: 3;
            -moz-column-count: 3;
        }

        .simple-form-ui input {
            min-width: 80%
        }

        form fieldset {
            min-width: 90%;
            display: block;
        }

        .encounter-summary-container #calculated-ratio {
            font-size: 1em;
            font-weight: normal;
        }

        #encounterDate input {
            min-width: 15%
        }

        div.inline-radio > * {
            display: inline;
            float: none !important;
            min-width: initial;
        }

        .light-font {
            font-family: "OpenSansLight",sans-serif;
        }

        .small {
            max-width: 10em;
            display: block;
            margin-bottom: 1em;
        }

        .small input {
            min-width: 4em;
            width: 4em;
            display: inline;
            margin-right: 0.5em;
        }

        .medium {
            max-width: 16em;
            display: block;
            margin-bottom: 1em;
        }

        .medium input {
            min-width: 8em;
            width: 8em;
            display: inline;
            margin-right: 0.5em;
        }

        .small-text {
            color: #555555;
            font-size: 90%;
            display: block;
        }

        .section-container {
            background: #F2F2F2;
            box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
            padding: 10px 5px 10px 15px;
            line-height: 1.5em; /*add this for vertical spacing between elements*/
        }

        .section-container input[type="checkbox"] {
            margin: 0px 5px; /*changed values to vertical, horizontal*/
            top:5px; /*added to offset the checkbox position to line up*/
        }

        .section-container label { /*new definition to override labels inside section-containers*/
            margin: 0px;
        }

        .question-container {
            background: #F2F2F2;
            box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
            padding: 5px 5px 10px 15px;
            margin: 5px 0;
            line-height: 1.5em; /*add this for vertical spacing between elements*/
        }

        .question-container label {
            margin-top: 5px;
        }

       - .section {
        width: 100%;
        }

        textarea {
            width: 95%;
        }

        /* Grey out disabled checkboxes */
        input[type=checkbox][disabled] {
            filter: invert(15%);
        }

        .section-button {
            margin: 10px 0 0 24px;
        }

        #diagnosis-lookup {
            display: inline-block;
            width: 50%;
            vertical-align: top;
        }

        #encounter-diagnoses-target {
            display: inline-block;
            width: 40%;
            vertical-align: top;
        }

        #encounter-diagnoses-app {
            margin-bottom: 20px;
        }

    </style>

    <div class="print-form-datestamps" style="display:none">
        <p><uimessage code="created_on"/>:
            <lookup complexExpression="$form.dateCreated"/>
        </p>
        <p><uimessage code="last_updated_on"/>:
            <lookup complexExpression="$form.dateChanged"/>
        </p>
        <p><uimessage code="printed_on"/>:
            <lookup complexExpression="$formGeneratedDatetime"/>
        </p>
    </div>

    <section id="vitals" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.vitals.label">
        <div class="section-container">
            <table>
                <thead>
                    <tr>
                        <td style="font-weight:bold">
                            <uimessage code="pihcore.vitals.latest.measurement.label"/>
                        </td>
                        <td style="font-weight:bold">
                            <uimessage code="zl.date"/>
                        </td>
                        <td style="font-weight:bold">
                            <uimessage code="pihcore.vitals.latest.results.label"/>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.bloodPressure.title" />
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:SYSTOLIC BLOOD PRESSURE').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:SYSTOLIC BLOOD PRESSURE').valueNumeric.intValue()"/>
                            <lookup complexExpression="#if($fn.latestObs('PIH:SYSTOLIC BLOOD PRESSURE')) / #end" />
                            <lookup expression="fn.latestObs('PIH:DIASTOLIC BLOOD PRESSURE').valueNumeric.intValue()"/>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.o2sat.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:BLOOD OXYGEN SATURATION').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:BLOOD OXYGEN SATURATION').valueNumeric.intValue()"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:BLOOD OXYGEN SATURATION')) % #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="pihcore.lab.glucose"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:SERUM GLUCOSE').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:SERUM GLUCOSE').valueNumeric.intValue()"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:Fasting for blood glucose test')) #if($fn.latestObs('PIH:Fasting for blood glucose test').valueCoded.name != 'No') (en ayuno) #else (sin ayuno) #end #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.temperature.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:TEMPERATURE (C)').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:TEMPERATURE (C)').valueNumeric"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:TEMPERATURE (C)')) Â°C #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.heartRate.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:PULSE').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:PULSE').valueNumeric.intValue()"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:PULSE')) ppm #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.respiratoryRate.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:RESPIRATORY RATE').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:RESPIRATORY RATE').valueNumeric.intValue()"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:RESPIRATORY RATE')) rpm #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.complaint.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('CIEL:160531').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('CIEL:160531').valueText"/>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <div class="hidden" id="logos" style="width=100%">
        <!-- These should appear in printed notes and prescriptions -->
        <img src="/openmrs/ms/uiframework/resource/pihcore/files/ces-logo.png" style="width: 20%; margin: 3% 5%;"/>
        <img src="/openmrs/ms/uiframework/resource/pihcore/files/ssa-fed-logo.jpg" style="width: 20%; margin: 0 5%;" />
        <img src="/openmrs/ms/uiframework/resource/pihcore/files/ssa-logo.png" style="width: 20%; margin: 0 5%;"/>
    </div>

    <div class="hidden" id="encounter-details"
         sectionTag="section" headerStyle="title" headerLabel="Encounter Details">
        <fieldset>
            <legend>When?</legend>
            <label>When?</label>

            <encounterDate default="now"/>
        </fieldset>

        <fieldset>
            <legend>Who?</legend>
            <label>Who?</label>

            <span id="provider-input">
            <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05"
                                      required="true"/>
            </span>
        </fieldset>

        <fieldset>
            <legend>Where?</legend>
            <label>Where?</label>

            <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/>
        </fieldset>
    </div>

    <section id="context" sectionTag="fieldset" headerTag="legend" headerStyle="title">
        <div class="section-container">
            <label>
                <uimessage code="pihcore.referredBy"/>
            </label>
            <obs conceptId="PIH:6189" id="referredBy"
                 answerConceptIds="PIH:12611,PIH:12612,PIH:12613,CIEL:1555,PIH:12614"
                 answerCodes="pihcore.hasAppointment,pihcore.walkIn,pihcore.activeCasefinding,pihcore.chw,pihcore.mentalHealthProgramForAdolescents"
                 style="radio" answerSeparator=""
            />
        </div>
    </section>

    <!-- Subjective -->
    <ifMode mode="VIEW" include="false">
        <h1>
            <uimessage code="pihcore.subjective.title"/>
        </h1>
    </ifMode>
    <section id="subjective" sectionTag="fieldset" headerTag="legend" headerStyle="title">
        <div class="section-container">
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <uimessage code="pihcore.subjective.title"/>
                        <lookup expression="fn.latestObs('CIEL:1390').obsDatetime" />
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('CIEL:1390').valueText" />
                    </p>
                    <br/>
                    <p>
                        <uimessage code="pihcore.lab.lab_tests.title"/>
                        <lookup expression="fn.latestObs('PIH:11762').obsDatetime" />
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('PIH:11762').valueText" />
                    </p>
                </div>
                <div>
                    <obs conceptId="CIEL:1390" style="textarea" rows="6" id="presenting-history"/>
                </div>
            </div>
        </div>
    </section>

    <!-- Objective -->
    <ifMode mode="VIEW" include="false">
        <h1>
            <uimessage code="pihcore.visitNote.objective"/>
        </h1>
    </ifMode>

    <section id="objective" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.ncd.info">
        <div class="section-container">
            <label>
                <uimessage code="pihcore.ncd.category"/>
            </label>
            <label class="half-size-text">
                <uimessage code="pihcore.ncd.category.instructions"/>
            </label>

            <!-- The ordering of these corresponds to the Spanish alphebetization -->
            <enrollInProgram programId="Asthma" showCheckbox="true" toggle="asthma"/>
            <uimessage code="pihcore.ncd.asthma"/>
            <br />
            <enrollInProgram programId="Malnutrition" showCheckbox="true"/>
            <uimessage code="pihcore.ncd.malnutrition"/>
            <br />
            <span id="diabetes-enroll">
                <enrollInProgram programId="Diabetes" showCheckbox="true"/>
            </span>
            <uimessage code="pihcore.ncd.diabetes"/>
            <br />
            <enrollInProgram programId="Epilepsy" showCheckbox="true" toggle="epilepsy"/>
            <uimessage code="pihcore.ncd.epilepsy"/>
            <br />
            <span id="htn-enroll" >
                <enrollInProgram programId="Hypertension" showCheckbox="true"/>
            </span>
            <uimessage code="pihcore.ncd.htn"/>
            <br />
            <enrollInProgram programId="ANC" showCheckbox="true" toggle="anc"/>
            <uimessage code="pihcore.mch.anc"/>
            <br />
            <enrollInProgram programId="Mental Health" showCheckbox="true" toggle="mental"/>
            <uimessage code="pihcore.ncd.mental"/>
        </div>

    </section>

    <!-- Asthma -->
    <section id="asthma" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.ncd.asthma">
        <div class="question-container">
            <includeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) > 4">
                <label>
                    <uimessage code="pihcore.daytime_symptoms"/>
                </label>
                <div class="two-columns">
                    <div>
                        <lookup expression="fn.latestObs('PIH:Daytime asthma symptoms more than twice per week').obsDatetime" />
                        <lookup complexExpression="#if($fn.latestObs('PIH:Daytime asthma symptoms more than twice per week')) &#8194; &#8227; &#8194; #end" />
                        <lookup expression="fn.latestObs('PIH:Daytime asthma symptoms more than twice per week').valueCoded.name" />
                    </div>
                    <div>
                        <obs conceptId="PIH:Daytime asthma symptoms more than twice per week"
                             answerConceptIds="PIH:YES,PIH:NO"
                             style="radio" answerSeparator="" />
                    </div>
                </div>
            </includeIf>
            <excludeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) > 4">
                <label>
                    <uimessage code="pihcore.daytime_symptoms_once"/>
                </label>
                <div class="two-columns">
                    <div>
                        <lookup expression="fn.latestObs('PIH:Daytime asthma symptoms for more than a few minutes more than once/week').obsDatetime" />
                        <lookup complexExpression="#if($fn.latestObs('PIH:Daytime asthma symptoms for more than a few minutes more than once/week')) &#8194; &#8227; &#8194; #end" />
                        <lookup expression="fn.latestObs('PIH:Daytime asthma symptoms for more than a few minutes more than once/week').valueCoded.name" />
                    </div>
                    <div>
                        <obs conceptId="PIH:Daytime asthma symptoms for more than a few minutes more than once/week"
                             answerConceptIds="PIH:YES,PIH:NO"
                             style="radio" answerSeparator="" />
                    </div>
                </div>
            </excludeIf>
        </div>

        <div class="question-container">
            <label>
                <uimessage code="pihcore.nighttime_symptoms"/>
            </label>
            <div class="two-columns">
                <div class="small-text">-</div>
                <div class="checkboxRadio">
                    <obsgroup groupingConceptId="PIH:FUNCTIONAL REVIEW OF SYMPTOMS CONSTRUCT">
                        <span class="two-columns">
                            <obs conceptId="PIH:SYMPTOM PRESENT" answerConceptId="CIEL:148273"
                                 answerCode="yes" answerSeparator=""/>
                            <obs conceptId="PIH:SYMPTOM ABSENT" answerConceptId="CIEL:148273"
                                 answerCode="no" answerSeparator="" />
                        </span>
                    </obsgroup>
                    <br/>

                    <script type="text/javascript">
                        /* Configure divs with class checkboxRadio to toggle the checkboxes as if they're radio buttons */
                        jQuery(document).on('click', ".checkboxRadio input[type$='checkbox']", function() {
                            var that = this;
                            jQuery(this).closest('.checkboxRadio').find("input[type$='checkbox']").each(function () {
                                if (jQuery(this).attr('id') != jQuery(that).attr('id')) {
                                    jQuery(this).prop("checked", false);
                                }
                            });
                        });
                    </script>
                </div>
            </div>
        </div>
        <div class="question-container">
            <label><uimessage code="pihcore.meds_2x_wk"/></label>
            <div class="two-columns">
                <div>
                    <lookup expression="fn.latestObs('PIH:Medications more than twice per week').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:Medications more than twice per week')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:Medications more than twice per week').valueCoded.name" />
                </div>
                <div>
                    <obs conceptId="PIH:Medications more that twice per week"
                         answerConceptIds="PIH:YES,PIH:NO"
                         style="radio" answerSeparator="" />
                </div>
            </div>
        </div>
        <div class="question-container">
            <label><uimessage code="pihcore.limitation_of_activity"/></label>
            <div class="two-columns">
                <div>
                    <lookup expression="fn.latestObs('PIH:Limitation of ability to perform main daily activities coded').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:Limitation of ability to perform main daily activities coded')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:Limitation of ability to perform main daily activities coded').valueCoded.name" />
                </div>
                <div>
                    <obs conceptId="PIH:Limitation of ability to perform main daily activities coded"
                         answerConceptIds="PIH:YES,PIH:NO"
                         style="radio" answerSeparator=""/>
                </div>
            </div>
        </div>
    </section>

    <!-- Diabetes -->
    <section id="diabetes" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.ncd.diabetes">
        <div class="question-container">
            <label><uimessage code="pihcore.lab.glucose"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <lookup expression="fn.latestObs('PIH:SERUM GLUCOSE').obsDatetime" />
                        <lookup complexExpression="#if($fn.latestObs('PIH:SERUM GLUCOSE')) &#8194; &#8227; &#8194; #end" />
                        <lookup expression="fn.latestObs('PIH:SERUM GLUCOSE').valueNumeric" />
                    </p>
                    <p>
                        <uimessage code="pihcore.lab.isFastingGlucose.title"/>:
                        <lookup expression="fn.latestObs('PIH:Fasting for blood glucose test').valueCoded.name" />
                    </p>
                </div>
                <div>
                    <obs id="glucose" class="small" conceptId="PIH:SERUM GLUCOSE" showUnits="true"/>
                    <label><uimessage code="pihcore.lab.isFastingGlucose.title"/></label>
                    <div class="inline-radio">
                        <obs id="fasting-for-glucose" conceptId="PIH:Fasting for blood glucose test"
                             answerConceptIds="PIH:YES,PIH:NO"
                             style="radio" answerSeparator="" />
                    </div>
                </div>
            </div>
        </div>
        <repeat>
            <template>
                <div class="question-container">
                    <label><uimessage code="{message}"/></label>
                    <div class="two-columns">
                        <div class="small-text">
                            <lookup expression="fn.latestObs('{concept}').obsDatetime" />
                            <lookup complexExpression="#if($fn.latestObs('{concept}')) &#8194; &#8227; &#8194; #end" />
                            <lookup expression="fn.latestObs('{concept}').valueNumeric" />
                        </div>
                        <div>
                            <obs class="small" conceptId="{concept}" showUnits="{showUnits}"/>
                        </div>
                    </div>
                </div>
            </template>
            <render message="pihcore.lab.hba1c" concept="PIH:HbA1c" showUnits="true"/>
            <render message="pihcore.lab.urinary_albumin" concept="PIH:URINARY ALBUMIN" showUnits="false" />
            <render message="pihcore.ncd.vitals.waist_cm" concept="CIEL:163080" showUnits="true" />
        </repeat>
        <div class="question-container">
            <label><uimessage code="pihcore.ncd.diabetes.foot_findings"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:FOOT EXAM FINDINGS').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:FOOT EXAM FINDINGS')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:FOOT EXAM FINDINGS').valueCoded.name" />
                </div>
                <div>
                    <obs conceptId="PIH:FOOT EXAM FINDINGS"
                         answerConceptIds="PIH:NOT DONE,PIH:NORMAL,PIH:FUNGAL INFECTION,PIH:KERATODERMA,PIH:FOOT ULCER" />
               </div>
            </div>
        </div>
        <repeat>
            <template>
                <div class="question-container">
                    <label><uimessage code="{message}"/></label>
                    <div class="two-columns">
                        <div class="small-text">
                            <lookup expression="fn.latestObs('{concept}').obsDatetime" />
                            <lookup complexExpression="#if($fn.latestObs('{concept}')) &#8194; &#8227; &#8194; #end" />
                            <lookup expression="fn.latestObs('{concept}').valueCoded.name" />
                        </div>
                        <div class="{obsDivClass}">
                            <obs conceptId="{concept}" style="radio" answerConceptIds="{answerConceptIds}"
                                 answerSeparator="{answerSeparator}"/>
                        </div>
                    </div>
                </div>
            </template>
            <render message="pihcore.ncd.diabetes.hypoglycemia_symptoms" concept="PIH:Hypoglycemia symptoms"
                    answerConceptIds="PIH:YES,PIH:NO"
                    obsDivClass="inline-radio" answerSeparator="&#8195;&#8195;"
            />
            <render message="pihcore.ncd.hx_alcohol_use" concept="PIH:HISTORY OF ALCOHOL USE"
                    answerConceptIds="PIH:IN THE PAST,PIH:CURRENTLY,PIH:NEVER,PIH:unknown"
                    obsDivClass="" answerSeparator=""
            />
            <render message="pihcore.ncd.hx_tobacco_use" concept="PIH:HISTORY OF TOBACCO USE"
                    answerConceptIds="PIH:IN THE PAST,PIH:CURRENTLY,PIH:NEVER,PIH:unknown"
                    obsDivClass="" answerSeparator=""
            />
        </repeat>
    </section>

    <script>
        /* Make the Cholesterol section show when Diabetes or Hypertension is checked */

        jq(function() {
            var dmCheckbox = jq("#diabetes-enroll > input[type='checkbox']")[0];
            var htnCheckbox = jq("#htn-enroll > input[type='checkbox']")[0];
            var dmSection = jq("#diabetes");
            var cholSection = jq("#cholesterol");

            var updateCholSectionVisibility = function() {
                if (dmCheckbox.checked | htnCheckbox.checked) {
                    cholSection.show();
                } else {
                    cholSection.hide();
                }
            };
            var updateDmSectionVisibility = function() {
                if (dmCheckbox.checked) {
                    dmSection.show();
                } else {
                    dmSection.hide();
                }
            };
            $(dmCheckbox).change(function() {
                updateDmSectionVisibility();
                updateCholSectionVisibility();
            });
            $(htnCheckbox).change(function() {
                updateCholSectionVisibility();
            });
            updateDmSectionVisibility();
            updateCholSectionVisibility();
        });
    </script>
    <section id="cholesterol" headerCode="pihcore.lab.cholesterol" sectionTag="fieldset" headerTag="legend" headerStyle="title">
        <div class="question-container">
            <label><uimessage code="pihcore.lab.total_chol"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:TOTAL CHOLESTEROL').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:TOTAL CHOLESTEROL')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:TOTAL CHOLESTEROL').valueNumeric" />
                </div>
                <div>
                    <obs id="chol" conceptId="PIH:TOTAL CHOLESTEROL" showUnits="true" class="small"/>
                </div>
            </div>
        </div>
        <div class="question-container">
            <label><uimessage code="pihcore.lab.hdl"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:HIGH-DENSITY LIPOPROTEIN CHOLESTEROL').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:HIGH-DENSITY LIPOPROTEIN CHOLESTEROL')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:HIGH-DENSITY LIPOPROTEIN CHOLESTEROL').valueNumeric" />
                </div>
                <div>
                    <obs id="ldl" conceptId="PIH:HIGH-DENSITY LIPOPROTEIN CHOLESTEROL" showUnits="true" class="small"/>
                </div>
            </div>
        </div>
        <div class="question-container">
            <label><uimessage code="pihcore.lab.ldl"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:LOW-DENSITY LIPOPROTEIN CHOLESTEROL').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:LOW-DENSITY LIPOPROTEIN CHOLESTEROL')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:LOW-DENSITY LIPOPROTEIN CHOLESTEROL').valueNumeric" />
                </div>
                <div>
                    <obs id="hdl" conceptId="PIH:LOW-DENSITY LIPOPROTEIN CHOLESTEROL" showUnits="true" class="small"/>
                </div>
            </div>
        </div>
    </section>


    <!-- Epilepsy -->
    <section id="epilepsy" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.ncd.epilepsy">
        <script>
            jq(function() {
                getField('epi-baseline.value').change(updatePercentReduction);
                getField('seizure-num.value').change(updatePercentReduction);
                updatePercentReduction();

                initializeBaseline();
            });

            function updatePercentReduction() {
                var baseline = parseInt(htmlForm.getValueIfLegal('epi-baseline.value'));
                if (isNaN(baseline)) {
                    baseline = parseInt(document.getElementById('epi-baseline-last-obs').innerHTML.trim());
                }
                var current = parseInt(htmlForm.getValueIfLegal('seizure-num.value'));
                var container = jq('#seizure-percent-reduction-container');
                if (!(isNaN(current) || isNaN(baseline))) {
                    var result = calculatePercentReduction(baseline, current).toString();
                    document.getElementById('seizure-percent-reduction').innerHTML = result;
                    container.show();
                } else {
                    container.hide();
                }
            }

            function calculatePercentReduction(baseline, current) {
                return Math.round(((baseline - current)/baseline) * 100);
            }

            function initializeBaseline() {
                var baseline = parseInt(document.getElementById('epi-baseline-last-obs').innerHTML.trim());
                var baselineInput = jq('#epi-baseline-input').hide();
                var baselineButton = jq('#change-epi-baseline-button').show();
                if (isNaN(baseline)) {
                    baselineButton.hide();
                    baselineInput.show();
                } else {
                    baselineInput.hide();
                    baselineButton.show();
                }
                jq('#change-epi-baseline-button').click(showChangeBaseline);
            }

            function showChangeBaseline() {
                jq('#epi-baseline-input').show();
            }
        </script>

        <div class="question-container">
            <p>
                <uimessage code="pihcore.ncd.epilepsy.seizure_num_baseline"/>
                <span id="epi-baseline-last-obs" class="value">
                    <lookup expression="fn.latestObs('PIH:Number of seizures in one month before medications').valueNumeric" />
                </span>
            </p>
            <div>
                <button id="change-epi-baseline-button" type="button">
                    <uimessage code="pihcore.ncd.epilepsy.change_baseline" />
                </button>
            </div>
            <div id="epi-baseline-input">
                <obs id="epi-baseline" class="small" conceptId="PIH:Number of seizures in one month before medications"/>
            </div>
        </div>

        <div class="question-container">
            <label><uimessage code="pihcore.ncd.epilepsy.seizure_num_1mo"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:Number of seizures in the past month').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:Number of seizures in the past month')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:Number of seizures in the past month').valueNumeric" />
                </div>
                <div>
                    <obs id="seizure-num" class="small" conceptId="PIH:Number of seizures in the past month"/>
                </div>
            </div>
        </div>
        <div id="seizure-percent-reduction-container" class="question-container">
            <p>
                <span id="seizure-percent-reduction" class="value" />
                <uimessage code="pihcore.ncd.epilepsy.percent_reduction"/>
            </p>
        </div>
    </section>

    <!-- Maternal -->
    <section id="anc" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.mch.anc">

        <ifMode mode="VIEW" include="false" >
            <script type="text/javascript">
                jq(function () {

                    var updateEdd = function () {
                        return updateEddFromData(getCurrentDate(), getLastPeriodDate());
                    };

                    var getCurrentDate = function () {
                        var currentEncounterDate = '<lookup expression="encounter.getEncounterDatetime().getTime()"/>';
                        if (typeof currentEncounterDate !== "undefined" &amp;&amp; (currentEncounterDate.length > 0)) {
                            // calculate the gestational age at the time of the encounter
                            return new Date(+currentEncounterDate);
                        } else {
                            return new Date();
                        }
                    };

                    var getLastPeriodDate = function () {
                        var datepickerValue = getField('lastPeriodDate.value').datepicker('getDate');
                        if (datepickerValue !== null) {
                            return datepickerValue;
                        }
                        var dateText = jq('#lmp-existing').text().trim();
                        if (dateText !== null &amp;&amp; dateText !== '') {
                            // We're going to use an absolutely evil hack to try and get a date object
                            // from the LMP string we have, without access to Moment.js or anything
                            // nice like that. We'll coerce the string into the input box, get the
                            // date object out, and reset the box.
                            // replace the slashes with spaces
                            var dateTextFormatted = dateText.replace(/\//g, " ");
                            // get the date object
                            var widgetDate = getField('lastPeriodDate.value').datepicker('setDate', dateTextFormatted).val();
                            var dateValue = new Date(getField('lastPeriodDate.value').datepicker('getDate'));
                            // reset the input box
                            getField('lastPeriodDate.value').datepicker('setDate', datepickerValue);
                            return dateValue;
                        }
                        return null;
                    };

                    var updateEddFromData = function (today, lastPeriodDate) {

                        if (typeof lastPeriodDate !== "undefined" &amp;&amp; lastPeriodDate !== null) {

                            // In order to get the date object to print in a nice, locale-specific way, we
                            // - store the current lastPeriodDate input value
                            // - calculate the EDD
                            // - use the lastPeriodDate box to coerce the EDD into the right format
                            // - set the EDD text with that formatted object
                            // - restore the lastPeriodDate to its actual value
                            var lmpInputValue = getField('lastPeriodDate.value').datepicker('getDate');
                            var newDate = new Date(lastPeriodDate);
                            var timeDiff = Math.abs(today.getTime() - newDate.getTime());
                            // weeks difference = gestational age
                            var diffWeeks = Math.ceil(timeDiff / (1000 * 3600 * 24 * 7));

                            // Estimated Delivery Date = (LMP - 3 months) + 12 months + 7 days
                            newDate.setMonth(newDate.getMonth() - 3);
                            newDate.setFullYear(newDate.getFullYear() + 1);
                            newDate.setDate(newDate.getDate() + 7);

                            var widgetDate = getField('lastPeriodDate.value').datepicker('setDate', newDate).val();
                            getField('lastPeriodDate.value').datepicker('setDate', lmpInputValue);

                            jq('#calculated-edd-and-gestational').show();
                            jq('#calculated-edd').text(widgetDate);
                            jq('#calculated-gestational-age-value').text(diffWeeks + " <uimessage code="pihcore.weeks"/>");

                        } else {
                            jq('#calculated-edd-and-gestational').hide();
                        }
                    };

                    jq('#calculated-edd-and-gestational').hide();

                    jq("#lastPeriodDate input[type='hidden']").change(function () {
                        updateEdd();
                    });

                    updateEdd();
                });
            </script>
        </ifMode>


        <!-- Last menstrual period (LMP or DDR) -->
        <div class="question-container">
            <label>
                <uimessage code="pihcore.pregnancy.lastPeriod"/>
            </label>
            <div class="two-columns">
                <div id="lmp-existing" class="small-text">
                    <lookup expression="fn.latestObs('CIEL:1427').valueDate"/>
                </div>
                <div class="medium">
                    <obs id="lastPeriodDate" conceptId="CIEL:1427" allowFutureDates="false"/>
                </div>
            </div>
        </div>
        <!-- G, P, C, A -->
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.grava"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:5624').valueNumeric"/>
                </div>
                <div class="small">
                    <obs conceptId="CIEL:5624" id="gravidaInput"/>
                </div>
            </div>
        </div>
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.para"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:1053').valueNumeric"/>
                </div>
                <div class="small">
                    <obs conceptId="CIEL:1053" />
                </div>
            </div>
        </div>
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.cesarian"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:160081').valueNumeric"/>
                </div>
                <div class="small">
                    <obs conceptId="CIEL:160081" />
                </div>
            </div>
        </div>
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.abortus"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:1823').valueNumeric"/>
                </div>
                <div class="small">
                    <obs conceptId="CIEL:1823" />
                </div>
            </div>
        </div>

        <div class="question-container">
            <label><uimessage code="pihcore.mch.ultrasoundResultText"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <!-- This doesn't work, but I'd like it to. See https://issues.openmrs.org/browse/RC-35 -->
                        <!-- <lookup complexExpression="#foreach($obs in $fn.allObs('PIH:7018')) $obs.obsDatetime #end"/> -->
                        <lookup expression="fn.latestObs('PIH:7018').obsDatetime"/>
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('PIH:7018').valueText"/>
                    </p>
                </div>
                <div>
                    <obs conceptId="PIH:7018" style="textarea" rows="4"/>
                </div>
            </div>
        </div>

        <!-- HIV & Syphalis tests -->
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.hivTest"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:163722').obsDatetime"/>
                </div>
                <div>
                    <obs conceptId="CIEL:163722" answerConceptId="CIEL:1065"
                         style="checkbox" />
                </div>
            </div>
        </div>
        <div class="question-container">
            <label>
                <uimessage code="pihcore.lab.vdrl"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:299').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('CIEL:299')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('CIEL:299').valueCoded.name" />
                </div>
                <div>
                    <obs conceptId="CIEL:299"
                         answerConceptIds="CIEL:703,CIEL:664"
                         style="radio" answerSeparator="" />
                </div>
            </div>
        </div>

        <div class="question-container">
            <label>
                <uimessage code="pihcore.lab.hemoglobin"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <!-- See https://issues.openmrs.org/browse/RC-35 -->
                    <lookup complexExpression="#foreach($obs in $fn.allObs('CIEL:21')) $obs.valueNumeric â $obs.obsDatetime #end"/>
                </div>
                <div>
                    <obs class="small" conceptId="CIEL:21" showUnits="true" />
                </div>
            </div>
        </div>

        <div class="question-container">
            <label><uimessage code="pihcore.lab.urinary_albumin"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:URINARY ALBUMIN').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:URINARY ALBUMIN')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:URINARY ALBUMIN').valueNumeric" />
                </div>
                <div>
                    <obs class="small" conceptId="PIH:URINARY ALBUMIN" />
                </div>
            </div>
        </div>

        <div class="question-container">
            <label>
                <uimessage code="pihcore.lab.blood_type"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:BLOOD TYPING').valueCoded.name"/>
                </div>
                <div>
                    <div class="inline-radio" >
                        <obs conceptId="PIH:BLOOD TYPING"
                             answerConceptIds="CIEL:690,CIEL:692,CIEL:694,CIEL:696,CIEL:699,CIEL:701,CIEL:1230,CIEL:1231,PIH:unknown"
                             answerCodes="A+,A-,B+,B-,O+,O-,AB+,AB-,PIH:unknown"/>
                    </div>
                </div>
            </div>
        </div>

        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.dtpGiven"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <!-- See https://issues.openmrs.org/browse/RC-35 -->
                    <lookup complexExpression="#foreach($obs in $fn.allObs('CIEL:984')) $obs.valueCoded.getShortNames() â $obs.obsDatetime #end"/>
                </div>
                <div>
                    <obs conceptId="CIEL:984" answerConceptId="CIEL:781" answerCode="SÃ­"/>
                </div>
            </div>
        </div>


        <div class="question-container">
            <label>
                <uimessage code="pihcore.lab.glucoseTolerance"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <!-- See https://issues.openmrs.org/browse/RC-35 -->
                    <lookup complexExpression="#foreach($obs in $fn.allObs('PIH:12051')) $obs.valueCoded.name â $obs.obsDatetime #end"/>
                </div>
                <div>
                    <obs conceptId="PIH:12051"
                         answerConceptIds="CIEL:1228,CIEL:1229"
                         answerCodes="pihcore.reactive,pihcore.nonreactive"
                         style="radio" answerSeparator="" />
                </div>
            </div>
        </div>

        <div id="calculated-edd-and-gestational" class="question-container hidden">
            <p>
                <span id="calculated-gestational-age-wrapper">
                    <span id="calculated-gestational-age-label">
                        <uimessage code="pihcore.calculatedGestationalAge"/>:&#160;
                    </span>
                    <span id='calculated-gestational-age-value' class="value"></span>
                </span>
            </p>
            <p>
                <span id="calculated-edd-wrapper">
                    <span id="calculated-edd-label">
                        <uimessage code="pihcore.calculatedEstimatedDeliveryDate"/>:&#160;
                    </span>
                    <span id='calculated-edd' class="value"></span>
                </span>
            </p>

        </div>

        <div class="question-container">
            <label><uimessage code="pihcore.mch.birthPlan"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:BIRTH PLAN').valueText" />
                </div>
                <div>
                    <obs conceptId="PIH:BIRTH PLAN" style="textarea" rows="4"/>
                </div>
            </div>
        </div>

    </section>

    <!-- Mental -->
    <section id="mental" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.ncd.mental">
        <div class="question-container">
            <div class="two-columns">
                <div>
                    <label>
                        <uimessage code="pihcore.ncd.mental.phq9Score"/>
                    </label>
                    <br />
                    <div class="small-text">
                        <p>
                            <lookup expression="fn.latestObs('CIEL:165137').obsDatetime" />
                            <lookup complexExpression="#if($fn.latestObs('CIEL:165137')) &#8194; &#8227; &#8194; #end" />
                            <lookup expression="fn.latestObs('CIEL:165137').valueNumeric" />
                        </p>
                    </div>
                </div>
                <div>
                    <div>
                        <a href="/openmrs/ms/uiframework/resource/pihcore/files/PHQ9-2018.pdf"
                           target="_blank" rel="noopener noreferrer">
                            <uimessage code="pihcore.ncd.mental.phq9FormLink" />
                        </a>
                    </div>
                    <div class="small">
                        <obs conceptId="CIEL:165137"/>
                    </div>
                </div>
            </div>
        </div>
        <div class="question-container">
            <div class="two-columns">
                <div>
                    <label><uimessage code="pihcore.ncd.mental.gad7Score"/></label>
                    <br />
                    <div class="small-text">
                        <p>
                            <lookup expression="fn.latestObs('CIEL:165185').obsDatetime" />
                            <lookup complexExpression="#if($fn.latestObs('CIEL:165185')) &#8194; &#8227; &#8194; #end" />
                            <lookup expression="fn.latestObs('CIEL:165185').valueNumeric" />
                        </p>
                    </div>
                </div>
                <div>
                    <div>
                        <a href="/openmrs/ms/uiframework/resource/pihcore/files/GAD7-CESPDF.pdf"
                           target="_blank" rel="noopener noreferrer">
                            <uimessage code="pihcore.ncd.mental.gad7FormLink" />
                        </a>
                    </div>
                    <div class="small">
                        <obs conceptId="CIEL:165185"/>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.exam.title" >
        <div class="section-container">
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <lookup expression="fn.latestObs('CIEL:1391').obsDatetime" />
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('CIEL:1391').valueText" />
                    </p>
                </div>
                <div>
                    <obs conceptId="CIEL:1391" style="textarea" rows="5"/>
                </div>
            </div>
        </div>
    </section>

    <!-- Analysis -->
    <ifMode mode="VIEW" include="false">
        <h1>
            <uimessage code="pihcore.visitNote.analysis"/>
        </h1>
    </ifMode>

    <section sectionTag="fieldset" headerTag="legend" headerStyle="title">
        <div class="section-container">
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <lookup expression="fn.latestObs('PIH:CLINICAL IMPRESSION COMMENTS').obsDatetime" />
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('PIH:CLINICAL IMPRESSION COMMENTS').valueText" />
                    </p>
                </div>
                <div>
                    <obs conceptId="PIH:CLINICAL IMPRESSION COMMENTS" style="textarea" rows="5"/>
                </div>
            </div>
        </div>
        <div class="question-container">
            <div id="diagnosis-lookup">
                <encounterDiagnosesByObs selectedDiagnosesTarget="#encounter-diagnoses-target"/>
            </div>
            <div id="encounter-diagnoses-target">
            </div>
        </div>
    </section>

    <!-- Plan -->
    <div id="section-plan">
        <ifMode mode="VIEW" include="false">
            <script type="text/javascript">

                // I don't really understand why this assignment `$j = jq` is required, but for some
                // reason a bunch of Javascript gets included in the page that expects `$j` to exist,
                // but doesn't define `$j` itself. *shrug emoji*
                var $j = jQuery;

                htmlForm.getBeforeValidation().push(function() {

                    var valid = true;

                    jq('fieldset.medication').each(function() {

                        // clear out any existing error messages
                        jq(this).find('.field-error').first().html('');

                        var medication = jq(this).find('.medication-name input').val();
                        var dose = jq(this).find('.dose input').val();
                        var doseUnits = jq(this).find('.dose-unit select').val();
                        var frequency = jq(this).find('.frequency select').val();
                        var duration = jq(this).find('.duration input').val();
                        var durationUnits = jq(this).find('.duration-unit select').val();
                        var instructions = jq(this).find('.medication-instructions input').val();

                        if (!medication &amp;&amp; (dose || doseUnits || frequency || duration || durationUnits || instructions)) {
                            valid = false;
                            jq(this).find('.field-error').first().append("<uimessage
                                code="pihcore.visitNote.plan.medications.error.noMedication"/>. ").show();
                        }

                        if (dose &amp;&amp; !doseUnits) {
                            valid = false;
                            jq(this).find('.field-error').first().append("<uimessage
                                code="pihcore.visitNote.plan.medications.error.noDoseUnits"/>. ").show();
                        }

                        if (!dose &amp;&amp; doseUnits) {
                            valid = false;
                            jq(this).find('.field-error').first().append("<uimessage
                                code="pihcore.visitNote.plan.medications.error.noDose"/>. ").show();
                        }

                        if (duration &amp;&amp; !durationUnits) {
                            valid = false;
                            jq(this).find('.field-error').first().append("<uimessage
                                code="pihcore.visitNote.plan.medications.error.noDurationUnits"/>. ").show();
                        }

                        if (!duration &amp;&amp; durationUnits) {
                            valid = false;
                            jq(this).find('.field-error').first().append("<uimessage
                                code="pihcore.visitNote.plan.medications.error.noDuration"/>. ").show();
                        }

                    });

                    return valid;

                });

                var MAX_MEDS = 30;  // this should match the number of items in the "repeat with=..." tag
                var numMeds = 1;
                var meds = [];
                jq(function() {

                    var hasValue = function (element) {
                        return jq(element).find('.medication-name input').val();
                    };

                    var initMeds = function () {
                        for (var i = 1; i &lt;= MAX_MEDS; i++) {
                            meds.push(jq('#medication-' + i));
                        }
                        for (var i = 1; i &lt; MAX_MEDS; i++) {
                            if (hasValue(meds[i])) {
                                numMeds = i + 1;
                            }
                        }
                        updateShownMeds();
                    };

                    var updateShownMeds = function () {
                        for (var i = 0; i &lt; MAX_MEDS; i++) {
                            if (i &lt; numMeds) {
                                meds[i].show();
                            } else {
                                meds[i].hide();
                            }
                        }
                    };

                    var incrementShownMeds = function () {
                        numMeds += 1;
                        updateShownMeds();
                    };

                    var decrementShownMeds = function () {
                        numMeds -= 1;
                        updateShownMeds();
                    };

                    jq('#show-more-medications-button').click(incrementShownMeds);
                    jq('#show-less-medications-button').click(decrementShownMeds);

                    initMeds();

                });

            </script>
        </ifMode>

        <ifMode mode="VIEW" include="false">
            <h1>
                <uimessage code="pihcore.visitNote.plan"/>
            </h1>
        </ifMode>

        <section id="clinical-management-plan" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.consult.clinicalManagementPlan">
            <div class="section-container">
                <div class="two-columns">
                    <div class="small-text">
                        <p>
                            <lookup expression="fn.latestObs('CIEL:162749').obsDatetime" />
                        </p>
                        <p>
                            <lookup expression="fn.latestObs('CIEL:162749').valueText" />
                        </p>
                    </div>
                    <div>
                        <obs conceptId="CIEL:162749" style="textarea" rows="5" id="clinical-management-plan"/>
                    </div>
                </div>
            </div>
        </section>

        <section id="test-orders" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.lab.lab_tests.title">
            <div class="section-container">
                <p>
                    <obs conceptId="PIH:11762" style="textarea" rows="5" id="test-orders"/>
                </p>
            </div>
        </section>

        <section id="drug-orders" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.ncd.meds">
            <div class="section-container">
                <repeat with="['1'],['2'],['3'],['4'],['5'],['6'],['7'],['8']">
                    <span id="medication-{0}" class="medication">
                        <obsgroup groupingConceptId="PIH:9070" showIfEmpty="false">
                            <h3>
                                <uimessage code="mirebalais.dispensing.medication"/>
                                {0}
                            </h3>
                            <fieldset class="medication">
                                <p class="field-error" style="display:none"></p>
                                <p>
                                    <label>
                                        <uimessage code="mirebalais.dispensing.medicationName"/>
                                    </label>
                                    <obs id="name{0}" class="medication-name" conceptId="CIEL:1282"
                                         answerDrugs="true"/>
                                </p>
                                <span class="med-details">
                                <p class="inline">
                                    <label>
                                        <uimessage code="dispensing.medication.dose"/>
                                    </label>
                                    <obs id="dose{0}" class="doseInput" conceptId="CIEL:160856"/>
                                    <obs id="doseUnit{0}" class="doseInput select-arrow" conceptId="PIH:9074"
                                         answers="mg,g,mL,Application,Capsule,Tablet,Drop,microgram,Patch,Pump,Sachet,IU"
                                         answerCodes="dispensing.units.mg,dispensing.units.g,dispensing.units.mL,dispensing.units.application,dispensing.units.capsule,dispensing.units.tablet,dispensing.units.drop,dispensing.units.mcg,dispensing.units.patch,dispensing.units.pump,dispensing.units.sachet,dispensing.units.IU"/>
                                </p>
                                <p class="inline">
                                    <label>
                                        <uimessage code="mirebalais.dispensing.medicationFrequency"/>
                                    </label>


                                    <obs id="frequencyCoded{0}" class="frequency select-arrow" conceptId="PIH:9363"
                                         answerConceptIds=
                                                 "PIH:OD,PIH:BID,PIH:TID,PIH:QID,PIH:5D,PIH:6D,PIH:7D,PIH:8D,PIH:9D,PIH:OM,PIH:ON,PIH:PRN,PIH:STAT,PIH:Q2H,PIH:Q3H,PIH:Q4H,PIH:Q6H,PIH:Q12H,PIH:5622"
                                         answerCodes="OD,BID,TID,QID,5D,6D,7D,8D,9D,OM,ON,SOS,STAT,Q2H,Q3H,Q4H,Q6H,Q12H,dispensing.general.other" />
                                </p>

                                <p class="inline">
                                    <label>
                                        <uimessage code="mirebalais.dispensing.medicationDuration"  />
                                    </label>
                                    <obs id="duration{0}" class="duration doseInput" conceptId="CIEL:159368"/>
                                    <obs id="durationUnit{0}" class="duration-unit select-arrow"
                                         conceptId="CIEL:1732"
                                         answerConceptIds="PIH:Days,PIH:1073,PIH:Months,PIH:Hours"/>
                                </p>
                                </span>
                                <p class="inline">
                                    <label>
                                        <uimessage code="mirebalais.dispensing.medicationAmount"/>
                                    </label>
                                    <obs id="amount{0}" conceptId="PIH:9071"/>
                                </p>
                                <p>
                                    <label>
                                        <uimessage code="mirebalais.dispensing.medicationInstructions"/>
                                    </label>
                                    <obs id="instructions{0}" class="medication-instructions" conceptId="PIH:9072"/>
                                </p>
                            </fieldset>
                        </obsgroup>
                    </span>
                </repeat>

                <button id="show-less-medications-button" type="button">
                    -
                </button>
                <button id="show-more-medications-button" type="button">
                    +
                </button>
            </div>

        </section>

        <section id="disposition-section" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="coreapps.consult.disposition">

            <div class="section-container">

                <p id="return-date">
                    <label>
                        <uimessage code="pihcore.visitNote.plan.approximateReturnVisitDate"/>
                    </label>
                    <span class="medium">
                        <obs conceptId="PIH:RETURN VISIT DATE" allowFutureDates="true" id="apptDate"/>
                    </span>
                </p>

            </div>

        </section>

    </div>  <!-- section-plan -->

    <!-- Print prescription -->
    <div class="section-button">
        <script type="text/javascript">
            // @bistenes: forgive me
            function print_prescription() {
                const w = window.open();
                const styleNodes = document.getElementsByTagName("style");
                for (var i = 0; i &lt; styleNodes.length; i++) {
                    const styleNode = styleNodes[i];
                    w.document.write("<style>" + styleNode.innerHTML + "</style>");
                }
                // w.document.write("<body></body>");
                w.document.write("<body>");
                const dateOptions = { year: 'numeric', month: 'short', day: 'numeric' };
                const dateString = new Date().toLocaleDateString("es", dateOptions);
                w.document.write('&lt;div class="date"&gt;' + dateString + '&lt;/div&gt;');
                const logos = jq(document.getElementById('logos')).clone();
                logos.removeClass("hidden");
                logos.appendTo(w.document.body);
                w.document.write("<p>");
                    const givenName = jq(document.getElementsByClassName('zl-givenName')[0]).clone();
                    givenName.text(givenName.text() + " ");
                    w.document.write(givenName.html());
                    const familyName = jq(document.getElementsByClassName('zl-familyName')[0]).clone();
                    familyName.text(familyName.text().match(/[^,]*/));
                    w.document.write(familyName.html());
                    w.document.write("</p>");
                w.document.write("<p>");
                    const gender = jq(document.getElementsByClassName('gender-age')[0].children[0]).clone();
                    gender.text(gender.text().match(/^\w+/) + ", ");
                    w.document.write(gender.html());
                    const age = jq(document.getElementsByClassName('gender-age')[0].children[1]).clone();
                    age.text(age.text().match(/\d+/));
                    w.document.write(age.html());
                    w.document.write("</p>");
                w.document.write("<p>");
                    w.document.write("Diagnosticos: ");
                    w.document.write(jq.map(jq(".diagnosis .matched-name"), d => d.textContent).join(", "));
                    w.document.write("</p>");
                jq(document.getElementById('drug-orders')).clone().appendTo(w.document.body);
                const medNames = jq(w.document).find(".medication-name");
                for (let i = 0; i &lt; medNames.length; i++) {
                    const medP = jq(medNames[i]).parent();
                    medP.css("display", "inline");
                }
                jq(document.getElementById('clinical-management-plan')).clone().appendTo(w.document.body);
                jq(document.getElementById('contact-info-inline')).clone().appendTo(w.document.body);
                w.document.write("<p>");
                    const nameLastFirst = jq("#provider-input").find("select option:selected").text();
                    const nameFirst = nameLastFirst.match(/, (.*)$/)[1];
                    const nameLast = nameLastFirst.match(/^(.*),/)[1];
                    const doctorNameLine = "Doctor: " + nameFirst + " " + nameLast;
                    w.document.write(doctorNameLine);
                    w.document.write("</p>");
                w.document.write("<p>");
                    w.document.write("PrÃ³xima cita: ");
                    w.document.write(jq("#apptDate").find(".hasDatepicker").val());
                    w.document.write("</p>");
                w.document.write(
                    "&lt;style&gt;" +
                    "h3 { display: none; }" +
                    ".date { position: absolute; top: 5px; right: 5px; }" +
                    ".inline { display: inline; }" +
                    ".med-details { display: none; }" +
                    ".zl-givenName { font-size: large; }" +
                    ".zl-familyName { font-size: large; }" +
                    "span[role=status] { display: none; }" +
                    "button { display: none; }" +
                    ".medication-name input { width: 60%; }" +
                    ".medication-instructions input { width: 80%; }" +
                    "&lt;/style&gt;"
                );
                w.document.write("</body>");
                w.print();
                w.close();
            }
        </script>

        <button onclick="print_prescription()" type="button">
            <uimessage code="pihcore.visitNote.printPrescriptions" />
        </button>
    </div>
    <br/>
    <ifMode mode="VIEW" include="false">
        <div id="buttons">
            <submit submitClass="confirm right" submitCode="mirebalais.save"/>
            <button type="button" class="cancel">
                <uimessage code="emr.cancel"/>
            </button>
        </div>
    </ifMode>

</htmlform>
